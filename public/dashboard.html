<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Audio Upload App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4">Audio Upload Dashboard</h1>

    <!-- Login/Register section -->
    <div id="authSection" class="mb-4">
      <div id="loggedOut" style="display: none;">
        <h4>Login</h4>
        <input id="loginUsername" class="form-control mb-2" placeholder="Username" />
        <input id="loginPassword" type="password" class="form-control mb-2" placeholder="Password" />
        <button onclick="login()" class="btn btn-primary">Login</button>

        <h5 class="mt-4">Or Register</h5>
        <input id="registerUsername" class="form-control mb-2" placeholder="Username" />
        <input id="registerPassword" type="password" class="form-control mb-2" placeholder="Password" />
        <button onclick="register()" class="btn btn-secondary">Register</button>
      </div>

      <div id="loggedIn" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong id="currentUser"></strong> is logged in.
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>

    <!-- Upload section -->
    <div class="card mb-4">
      <div class="card-header">Upload a WAV or WEBM File</div>
      <div class="card-body">
        <input type="file" id="fileInput" accept="audio/*" class="form-control mb-3" />
        <button onclick="upload()" class="btn btn-success">Upload</button>
        
      </div>
    </div>

    <!-- Record section -->
    <div class="card mb-4">
      <div class="card-header">Record & Upload</div>
      <div class="card-body">

        <label for="micSelect" class="form-label">Select Microphone:</label>
        <select id="micSelect" class="form-select mb-3"></select>
        <button id="recordBtn" class="btn btn-warning">Start Recording</button>
        <span id="recordingStatus" class="ms-3 text-muted"></span>
      </div>
    </div>

    <!-- Files list -->
    <div class="card mb-4">
      <div class="card-header">Uploaded Files</div>
      <ul id="fileList" class="list-group list-group-flush"></ul>
    </div>

    <!-- Waveform player -->
    <div class="card" id="wavePlayerCard" style="display: none;">
      <div class="card-header">Waveform Viewer</div>
      <div class="card-body">
        <div id="waveform" class="waveform border rounded mb-3"></div>
        <button id="playPauseBtn" class="btn btn-sm btn-primary">
          <i class="bi bi-play-fill"></i> Play
        </button>
      </div>
    </div>
  </div>

  <script>
    let wavesurfer, mediaRecorder, audioChunks = [];

    let user = null;
    async function populateMicList() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const micSelect = document.getElementById('micSelect');
        micSelect.innerHTML = '';

        for (const device of devices) {
          if (device.kind === 'audioinput') {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Microphone ${micSelect.length + 1}`;
            micSelect.appendChild(option);
          }
        }
      } catch (err) {
        console.error('Failed to get microphone devices:', err);
      }
    }

    async function checkLogin() {
      try {
        const res = await fetch('/me');
        const data = await res.json();
        if (data.loggedIn) {
          user = data.user;
          document.getElementById('loggedIn').style.display = 'block';
          document.getElementById('loggedOut').style.display = 'none';
          document.getElementById('currentUser').innerText = user.username;
          await populateMicList(); 
          loadFiles(); // ‚úÖ Âè™ÊúâÁôªÂΩïÂêéÊâçÂä†ËΩΩÊñá‰ª∂
        } else {
          user = null;
          document.getElementById('loggedIn').style.display = 'none';
          document.getElementById('loggedOut').style.display = 'block';
        }
      } catch (err) {
        console.error('Failed to fetch login status:', err);
      }
    }

    async function register() {
      const username = document.getElementById('registerUsername').value;
      const password = document.getElementById('registerPassword').value;
      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      alert(data.message);
      if (data.success) {
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerPassword').value = '';
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      alert(data.message);
      // if (data.success) {
      //   checkLogin();
      // }
      if (data.success) {
      //alert('Login successful!');
      window.location.href = '/dashboard.html'; // ‚úÖ Ë∑≥ËΩ¨Âà∞ÂäüËÉΩÈ°µ
      } else {
        alert(data.message || 'Login failed.');
      }

    }

    async function logout() {
      await fetch('/logout');
      window.location.href = '/'; // ‚úÖ ÂõûÂà∞È¶ñÈ°µ
      //location.reload();
    }

    async function upload() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("No file selected.");
      const formData = new FormData();
      formData.append('audio', file);
      await fetch('/upload', { method: 'POST', body: formData });
      loadFiles();
    }

    document.getElementById('recordBtn').addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
      
        const selectedMicId = document.getElementById('micSelect').value;
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { deviceId: { exact: selectedMicId } }
        });

        // Ê£ÄÊü• stream ÊòØÂê¶Ê≠£Â∏∏
        console.log('üéôÔ∏è Stream tracks:', stream.getAudioTracks());
        if (stream.getAudioTracks().length === 0) {
          alert('No audio input device found.');
          return;
        }

        const options = { mimeType: 'audio/webm;codecs=opus' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          alert('Your browser does not support audio/webm with opus.');
          return;
        }

        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => {
          console.log('üéôÔ∏è Data available:', e.data);
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
          console.log('üéôÔ∏è Final blob size:', blob.size);
          if (blob.size === 0) {
            alert("No audio recorded. Please check your microphone.");
            return;
          }

          const formData = new FormData();
          formData.append('audio', blob, 'recording.webm');
          await fetch('/upload', { method: 'POST', body: formData });
          loadFiles();
        };

        mediaRecorder.start();
        document.getElementById('recordingStatus').innerText = 'Recording...';
        document.getElementById('recordBtn').innerText = 'Stop Recording';
      } else {
        mediaRecorder.stop();
        document.getElementById('recordingStatus').innerText = 'Uploading recording...';
        document.getElementById('recordBtn').innerText = 'Start Recording';
      }
    });






    async function loadFiles() {
      const ul = document.getElementById('fileList');
      ul.innerHTML = '<li class="list-group-item">Loading...</li>';
      const res = await fetch('/files');
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        ul.innerHTML = '<li class="list-group-item text-muted">No files uploaded.</li>';
        return;
      }
      ul.innerHTML = '';
      for (const f of data) {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const divLeft = document.createElement('div');
        divLeft.innerHTML = `
          <a href="#" onclick="loadAndPlayWaveform('${f.path}')"><strong>${f.name}</strong></a><br/>
          <small>${f.upload_time}</small>
        `;
        const divRight = document.createElement('div');
        divRight.innerHTML = `<code>${f.path}</code>`;

        if (user && user.role === 'admin') {
          const uploader = document.createElement('div');
          uploader.className = 'text-muted small';
          uploader.innerText = `Uploaded by: ${f.username || 'Unknown'}`;
          divRight.appendChild(uploader);
        }


        const downloadBtn = document.createElement('a');
        downloadBtn.href = f.path;
        downloadBtn.download = f.name;
        downloadBtn.className = 'btn btn-sm btn-outline-primary ms-2';
        downloadBtn.innerHTML = '<i class="bi bi-download"></i>';
        divRight.appendChild(downloadBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-outline-danger ms-2';
        delBtn.innerHTML = '<i class="bi bi-trash"></i>';
        delBtn.addEventListener('click', () => deleteFile(f.id));
        divRight.appendChild(delBtn);

        li.appendChild(divLeft);
        li.appendChild(divRight);
        ul.appendChild(li);
      }
    }

    async function deleteFile(id) {
      if (!confirm('Delete this file?')) return;
      const res = await fetch(`/files/${id}`, { method: 'DELETE' });
      const result = await res.json();
      if (result.success) loadFiles();
    }

    function loadAndPlayWaveform(path) {
      if (wavesurfer) wavesurfer.destroy();
      wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#a0c4ff',
        progressColor: '#4361ee',
        height: 100,
        responsive: true
      });
      wavesurfer.load(path);
      document.getElementById('wavePlayerCard').style.display = 'block';
      const btn = document.getElementById('playPauseBtn');
      btn.innerHTML = `<i class="bi bi-play-fill"></i> Play`;
      wavesurfer.on('play', () => {
        btn.innerHTML = `<i class="bi bi-pause-fill"></i> Pause`;
      });
      wavesurfer.on('pause', () => {
        btn.innerHTML = `<i class="bi bi-play-fill"></i> Play`;
      });
    }

    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (wavesurfer) wavesurfer.playPause();
    });

    checkLogin();
  </script>
</body>
</html>
